flowchart LR
  subgraph Client["Workbench Renderer (Client)"]
    Dev["Developer"]
    ChatUI["Existing Chat UI"]
    Bridge["VSCloneUsageSessionBridge"]
    UsageSvc["VSCloneUsageService"]
    Agg["VSCloneUsageAggregationService"]
    Budget["VSCloneUsageBudgetPolicy"]
    View["VSCloneUsageLogViewPane"]
  end

  subgraph Server["Extension Host / Chat Runtime"]
    ChatModel["IChatService + IChatModel"]
  end

  subgraph Cloud["Provider Cloud APIs"]
    Inference["Provider Inference API"]
    UsageAPI["Provider Usage API\n(OpenAI/Anthropic/...)"]
    QuotaAPI["Provider Quota/Billing API"]
  end

  subgraph Local["Local Persistence"]
    Store["VSCloneUsageStore"]
    Ledger[("usage-ledger.jsonl")]
    Summary[("usage-summary.json")]
  end

  Dev -->|prompt| ChatUI
  ChatUI -->|request| ChatModel
  ChatModel -->|inference request| Inference
  Inference -->|response + provider correlation id| ChatModel

  ChatModel -->|request lifecycle + provider references| Bridge
  Bridge -->|normalized request references| UsageSvc

  UsageSvc -->|sync query by provider request id| UsageAPI
  UsageAPI -->|authoritative token/cost rows| UsageSvc

  UsageSvc -->|quota query| QuotaAPI
  QuotaAPI -->|remaining quota snapshot| UsageSvc

  UsageSvc --> Agg
  Agg --> Budget
  UsageSvc -->|state updates| View
  UsageSvc -->|append + compact| Store
  Store --> Ledger
  Store --> Summary

  View -->|export/copy/filter/clear/sync| UsageSvc
