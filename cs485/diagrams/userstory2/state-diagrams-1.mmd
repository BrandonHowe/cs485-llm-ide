stateDiagram-v2
  [*] --> RequestObserved
  RequestObserved --> AwaitingUsage
  AwaitingUsage --> UsageStreaming: usage update arrives
  AwaitingUsage --> MissingUsageFallback: request completes with no usage payload
  UsageStreaming --> UsageStreaming: additional usage update
  UsageStreaming --> Finalized: request completed/cancelled/failed
  MissingUsageFallback --> Finalized: finalize with unknown usage flag
  Finalized --> PersistQueued
  PersistQueued --> Persisted
  PersistQueued --> PersistRetry: write failure
  PersistRetry --> PersistQueued
  Persisted --> Pruned: retention/clear action
  Pruned --> [*]
