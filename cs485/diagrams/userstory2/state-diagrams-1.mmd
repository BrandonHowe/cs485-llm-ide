stateDiagram
  [*] --> RequestObserved
  RequestObserved --> AwaitingProviderReference
  AwaitingProviderReference --> PendingSync: provider correlation captured
  AwaitingProviderReference --> SyncFailed: request completed without correlation id
  PendingSync --> SyncInFlight: scheduler dispatches sync
  SyncInFlight --> Synced: provider usage row received
  SyncInFlight --> SyncRetry: transient provider error
  SyncRetry --> SyncInFlight
  SyncInFlight --> SyncFailed: terminal provider error
  Synced --> PersistQueued
  SyncFailed --> PersistQueued
  PersistQueued --> Persisted
  PersistQueued --> PersistRetry: write failure
  PersistRetry --> PersistQueued
  Persisted --> Pruned: retention/clear action
  Pruned --> [*]
