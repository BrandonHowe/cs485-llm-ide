flowchart TD
  A[User sends request in Chat] --> B[Chat model starts request]
  B --> C[Bridge records request reference]
  C --> D{provider correlation id available?}
  D -- no --> E[Mark entry sync_failed no_correlation]
  D -- yes --> F[Queue provider usage sync]
  F --> G[Call provider usage API]
  G --> H{usage row returned?}
  H -- no --> I[Mark entry sync_failed with provider error]
  H -- yes --> J[Normalize provider tokens cost and quota fields]
  J --> K[Append/update usage entry in model]
  E --> K
  I --> K
  K --> L[Debounced persist to ledger + summary]
  L --> M{persist ok?}
  M -- yes --> N[Refresh side panel and totals]
  M -- no --> O[Retry with backoff + telemetry/log]
  N --> P[User filters exports clears syncs]
  P --> Q[Action registrar routes command]
  Q --> R[Usage service executes action]
