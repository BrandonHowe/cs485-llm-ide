flowchart TD
  A[User opens unified chat pane] --> B[User selects thread in history rail]
  B --> C[Restore thread context and model selection]
  C --> D[User sends prompt from composer]
  D --> E[Existing IChatService processes request]
  E --> F[VSCloneChatSessionBridge receives addRequest event]
  F --> G{Thread exists for sessionResource?}
  G -- No --> H[Create thread metadata]
  G -- Yes --> I[Reuse existing thread]
  H --> J[Create pending turn with prompt text]
  I --> J
  J --> K[Receive streaming response events]
  K --> L[Update in-memory turn content]
  L --> M{Response terminal state?}
  M -- No --> K
  M -- Yes --> N[Finalize turn and capture model metadata]
  N --> O[VSCloneChatHistoryService marks model dirty]
  O --> P[Persist thread plus index]
  P --> Q{Persist success?}
  Q -- Yes --> R[Refresh history rail in unified pane]
  Q -- No --> S[Retry with backoff and log]
  R --> T[User selects history item]
  T --> U{Action}
  U -- Copy --> V[Copy prompt or response to clipboard]
  U -- Reuse --> W[Set chat input and restore turn model]
  U -- Open --> X[Open and focus original session]
