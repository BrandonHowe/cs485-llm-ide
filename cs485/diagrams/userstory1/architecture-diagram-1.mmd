flowchart LR
  subgraph Client["Workbench Renderer (Client)"]
    Dev["Developer"]
    ChatUI["VSClone Unified Chat View"]
    HistRail["History Rail (embedded)"]
    Composer["Composer + Model Toolbar"]
    Bridge["VSCloneChatSessionBridge"]
    HistSvc["VSCloneChatHistoryService"]
    ThreadSel["External: VSCloneThreadModelSelectionService (Story 3)"]
  end

  subgraph Server["Extension Host / Remote Agent (Server Process)"]
    ChatSvc["IChatService + IChatModel (existing)"]
  end

  subgraph Local["Local Persistence (Workspace/Profile Storage)"]
    Store["VSCloneChatHistoryStore"]
    Index[("history.index.v1.json")]
    Threads[("threads/{threadId}.v1.json")]
  end

  subgraph Cloud["LLM Provider (Cloud)"]
    LLM["Model API (existing provider path)"]
  end

  Dev -->|Select thread / browse history| HistRail
  Dev -->|Prompt text + context| Composer
  ChatUI --> HistRail
  ChatUI --> Composer
  ChatUI -->|sendRequest| ChatSvc
  ChatSvc -->|Request| LLM
  LLM -->|Streaming tokens + final response| ChatSvc

  ChatSvc -->|onDidCreateModel/onDidChange events| Bridge
  Bridge -->|Normalized turn updates| HistSvc
  HistSvc -->|Observable updates| HistRail
  HistSvc -->|Persist deltas| Store
  Store --> Index
  Store --> Threads

  HistRail -->|Thread selection| ThreadSel
  ThreadSel -->|Restore model for active thread| Composer
  HistRail -->|Copy/Reuse/Open Session| ChatUI
