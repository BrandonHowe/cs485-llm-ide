flowchart TD
  A[User selects thread in history rail] --> B[Restore model for active thread]
  B --> C[User clicks provider/model dropdown]
  C --> D[ModelPickerController.open]
  D --> E[Fetch providers/models from CatalogService]
  E --> F[Apply compatibility filtering by thread context]
  F --> G{Any valid models?}
  G -- No --> H[Show empty-state + Manage Providers action]
  G -- Yes --> I[Render grouped dropdown sections]
  I --> J[User selects provider/model]
  J --> K[Validate availability + compatibility]
  K --> L{Provider configured/authenticated?}
  L -- No --> M[Open provider configuration flow]
  M --> E
  L -- Yes --> N[ThreadSelectionService.setSelectionForThread]
  N --> O[Persist thread selection + update recents]
  O --> P[Update composer label and active-model badge]
  P --> Q[Next sendRequest uses userSelectedModelId]
  Q --> R{Model unavailable at send time?}
  R -- Yes --> S[Apply fallback or prompt re-selection]
  R -- No --> T[Request routed to selected provider/model]
